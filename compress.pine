#!/bin/bash -x

## jobs
j=4
targets=$@

## cleanup
find {/bin,/usr/bin,/sbin,/usr/sbin}/*.{000,upx} -exec rm {} + &>/dev/null

pack(){
	upx --best $@ &>/dev/null &
}

UFS=' '
for t in $targets ; do
	while [ `pgrep upx | wc -l` -gt $j ] ; do sleep 3 ; done
	pack $t
done

## wait completion
while [ `pgrep upx | wc -l` -gt 0 ] ; do sleep 3 ; done
